<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>PPINOT Model Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="manager/css/bootstrap.css" rel="stylesheet">
    <style>
        body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
        }

        p.row-fluid:hover .actions {
            visibility: visible;
        }

        .actions {
            visibility: hidden;
            margin-top: 10px;
        }

        .model-title {
        }

        #models hr {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        #editModelNavbar {
            width: 206px;
            -webkit-transition: width .5s ease;
            -moz-transition: width .5s ease;
            -o-transition: width .5s ease;
            -ms-transition: width .5s ease;
            transition: width .5s ease;
        }

        #editModelNavbar:focus {
            width: 366px;
        }

        .navbar-form .input-prepend {
            margin-bottom: 5px;
        }

    </style>
    <link href="manager/css/bootstrap-responsive.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="brand" href="#">PPINOT Modeller</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    <li class="active"><a href="#">Models</a></li>
                    <li class="divider-vertical"></li>
                </ul>

                <form id="editModelFormNavbar" class="navbar-form pull-left">
                    <input id="editModelNavbar" placeholder="Edit model" autocomplete="off" type="text" />
                </form>


                <ul class="nav pull-right">
                    <li><a href="#about">About</a></li>
                    <li class="divider-vertical"></li>
                    <li class="dropdown" id="login"><a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="username">Log in</span> <b class="caret"></b></a>
                        <div class="dropdown-menu" style="padding: 15px">
                            <a class="btn btn-primary btn-block" href="socialauth.do?id=googlePlus" id="sign-in-google">Sign In with Google</a>
                            <a class="btn btn-primary btn-block" href="socialauth.do?id=facebook" id="sign-in-facebook">Sign In with Facebook</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="container">

    <p style="float:right;"><button id="add" class="btn btn-info hide"><i class='icon-plus-sign'></i> Add new model</button> </p>
    <h1>Models</h1>

    <hr/>

    <div id="models" class="span8 offset2">

    </div>

</div> <!-- /container -->

<div id="removeModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="removeModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="removeModalLabel">Delete model</h3>
    </div>
    <div class="modal-body">
        <p>Model <span id="removeModelId"></span> is going to be deleted. Do you want to continue?</p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button id="acceptRemove" class="btn btn-primary">Accept</button>
    </div>
</div>

<div id="addModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="addModalLabel">Add new model</h3>
    </div>
    <form action="#" target="_blank" method="post" class="form-horizontal" id="addModelForm" accept-charset="utf-8">
    <div class="modal-body">
        <div class="alert alert-error hide" id="errorAdding">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <strong>Warning!</strong> There was an error creating the model.
        </div>
        <div class="control-group">
            <label for="modelId" class="control-label">
                Model id:
            </label>
            <div class="controls">
                <input name="modelId" value="" id="modelId" placeholder="Model identifier" disabled required="true" type="text">
            </div>
        </div>
        <div class="control-group">
            <label for="name" class="control-label">
                Name:
            </label>
            <div class="controls">
                <input name="name" value="" id="name" placeholder="Model name (required)" required="true" type="text">
            </div>
        </div>
        <div class="control-group">
            <label for="description" class="control-label">
                Description:
            </label>
            <div class="controls">
                <textarea rows="6"  id="description" name="description" placeholder="Description of the model"></textarea>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button id="acceptAdd" type="submit" class="btn btn-primary">Accept</button>
    </div>
    </form>
</div>

<div id="openModelModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="openModelModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="openModelModalLabel">New model successfully created</h3>
    </div>
    <div class="modal-body">
        <p>The model has been successfully created, do you want to edit it?</p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">No</button>
        <a id="openModel" href="#" target="_blank" class="btn btn-primary">Yes</a>
    </div>
</div>


<!-- JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="manager/modelhandler.js"></script>
<script src="manager/navbar.js"></script>
<script src="libs/bootstrap.js"></script>
<script src="libs/jquery.json-2.3.js"></script>

<script type="text/javascript" charset="utf-8">
// <![CDATA[

$(document).ready(function() {
    var modelHandler = new ModelHandler();

    $("#add").click(function () {
        $("#name").val("");
        $("#description").val("");
        $("#modelId").val("");
        $("#errorAdding").hide();
        $("#addModal").modal("show");
    });

    $("#openModel").click( function () {
        $("#openModelModal").modal("hide");
    });

    $("#name").keyup(function () {
        $("#modelId").val(JSON.stringify($("#name").val()).replace( /\W/g , ''));
    });

    $("#addModelForm").submit(function () {
        var model = {
            modelId: $("#modelId").val(),
            name: $("#name").val(),
            description: $("#description").val()
        };

        modelHandler.addModel(model).done(function(data) {
            loadModels();
            $("#addModal").modal("hide");
            $("#openModel").attr("href", data.editor);
            $("#openModelModal").modal("show");
        }).fail(function() {
                $("#errorAdding").show();
        });

        return false;
    });




    var loadModels = function() {
        modelHandler.loadModelsList().done(function(processes) {
            var models = $("#models");
            models.empty();

            $(processes).each(function() {
                var container = $("<p class='row-fluid'></p>");

                var actions = $("<ul class='pull-right actions inline'></ul>").appendTo(container);
                addActions(this, actions);

                var title = $("<h4 class='model-title'></h4>").appendTo(container);
                if (this.editor != "undefined" && this.editor != null)
                    title.append("<a target='_blank' href='"+this.editor+"'>"+this.name+"</a>");
                else
                    title.append(this.name);


                if (this.description !== "undefined" && this.description != null)
                    container.append("<p>"+this.description+"</p>");


                models.append(container);
                models.append("<hr/>");

            });

        });
    }

    var addActions = function(model, container) {
        container.append("<li><a class='btn btn-mini' href='"+model.url+"'><i class='icon-download'></i> Download XML</a></li>");

        if (NavBar.isLogged()) {
            var remove = $("<a class='btn btn-mini' href='#'><i class='icon-trash'></i> Delete model</a>").click(function() {
                $("#removeModelId").html(model.modelId);
                $("#acceptRemove").unbind().click(function() {
                    console.log("Removed "+model.modelId);
                    $("#removeModal").modal("hide");
                    modelHandler.removeModel(model.modelId);
                    loadModels();
                });
                $("#removeModal").modal("show");
            });
            $("<li></li>").append(remove).appendTo(container);
        }

    };

    NavBar.onLogin.add(loadModels);
    NavBar.onLogin.add(function (logged) {
        if (!logged) {
            $("#add").hide();
        }
        else {
            $("#add").show();
        }
    });

    NavBar.init();

});
// ]]>
</script>
</body>
</html>
